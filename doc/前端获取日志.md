# Supabase日志系统接入方案

## 背景

根据 [Supabase 官方讨论](https://github.com/orgs/supabase/discussions/34832) 和 [Supabase Management API 文档](https://api.supabase.com/api/v1#tag/analytics/GET/v1/projects/{ref}/analytics/endpoints/logs.all)，我们需要设计一个安全、高效的方案来访问 Supabase 日志，并在前端展示。

## 方案设计

### 1. 架构概述

我们采用 Edge Function 作为中间层，使用 Management API Access Token 访问 Management API，然后将日志安全地返回给前端。

```
前端应用 (Vue 3) -> Edge Function -> Supabase Management API
```

### 2. Edge Function 实现

在 `supabase/functions/system-logs/index.ts` 中实现：

```typescript
// 定义日志类型枚举和对应的表名
export enum LogTable {
  Auth = 'auth_logs',
  Edge = 'edge_logs',
  FunctionEdge = 'function_edge_logs',
  Function = 'function_logs',
  PgBouncer = 'pgbouncer_logs',
  Postgres = 'postgres_logs',
  Postgrest = 'postgrest_logs',
  Realtime = 'realtime_logs',
  Storage = 'storage_logs',
  Supervisor = 'supervisor_logs'
}

// 定义请求参数接口
interface LogsQueryParams {
  type?: string;
  iso_timestamp_start?: string;
  iso_timestamp_end?: string;
}

// Supabase项目信息和访问令牌
const SUPABASE_PROJECT_ID = "your_project_id"
const SUPABASE_ACCESS_TOKEN = "your_access_token"

// 处理请求的主函数
serve(async (req) => {
  // 处理跨域请求
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    // 从请求中获取参数 (支持JSON和URL查询字符串)
    let params: LogsQueryParams = {};
    
    if (req.method === 'POST') {
      // 尝试从请求体解析JSON
      params = await req.json().catch(() => ({}));
  }
  
    // 如果没有从请求体获取到参数，尝试从URL查询字符串获取
    if (Object.keys(params).length === 0) {
  const url = new URL(req.url);
      params = {
        type: url.searchParams.get('type') || undefined,
        iso_timestamp_start: url.searchParams.get('iso_timestamp_start') || undefined,
        iso_timestamp_end: url.searchParams.get('iso_timestamp_end') || undefined
      };
    }
    
    // 参数提取
    const { type, iso_timestamp_start, iso_timestamp_end } = params;
    
    // 时区处理：支持直接输入北京时间，自动转换为UTC时间
    const convertToUTC = (beijingTimeIso: string | undefined): string | undefined => {
      if (!beijingTimeIso) return undefined;
      try {
        const date = new Date(beijingTimeIso);
        date.setHours(date.getHours() - 8); // 减去8小时调整为UTC
        return date.toISOString();
      } catch (e) {
        return undefined;
      }
    };
  
    // 时间参数处理
    let startTime = convertToUTC(iso_timestamp_start) || '';
    let endTime = convertToUTC(iso_timestamp_end) || '';
    
    // 当前时间（UTC）
    const now = new Date();
    const nowIso = now.toISOString();
    
    // 设置默认时间范围（24小时）
    if (!startTime && !endTime) {
      const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      startTime = oneDayAgo.toISOString();
      endTime = nowIso;
    } else if (startTime && !endTime) {
      endTime = nowIso;
    } else if (!startTime && endTime) {
      const oneDayAgo = new Date(new Date(endTime).getTime() - 24 * 60 * 60 * 1000);
      startTime = oneDayAgo.toISOString();
  }
  
    // 确保时间范围不超过24小时
    const diffHours = (new Date(endTime).getTime() - new Date(startTime).getTime()) / (1000 * 60 * 60);
    if (diffHours > 24) {
      startTime = new Date(new Date(endTime).getTime() - 24 * 60 * 60 * 1000).toISOString();
    }
    
    // 确定日志表
    let logTable = '';
    // 根据type参数确定日志表
    switch(type ? type.toLowerCase() : 'edge') {
      case 'auth': logTable = LogTable.Auth; break;
      case 'api': 
      case 'edge': logTable = LogTable.Edge; break;
      case 'function_edge': logTable = LogTable.FunctionEdge; break;
      case 'function': logTable = LogTable.Function; break;
      case 'postgres':
      case 'database': logTable = LogTable.Postgres; break;
      // ... 其他日志类型
      default: logTable = LogTable.Edge;
    }
    
    // 根据日志表生成对应的SQL查询
    let sql = '';
    
    // 转换时间戳为可读格式（中国时区）
    const timestampSelect = 'datetime(timestamp, "Asia/Shanghai") as formatted_time';
    
    // 根据不同日志表生成对应的SQL
    if (logTable === LogTable.Edge) {
      sql = `
        SELECT 
          ${timestampSelect},
          id,
          event_message,
          r.method as request_method,
          r.path as request_path,
          r.host as request_host,
          rs.status_code as response_status,
          h.x_real_ip as client_ip,
          h.user_agent as user_agent,
          r.sb as supabase_auth
        FROM ${logTable}
        CROSS JOIN UNNEST(metadata) as m
        CROSS JOIN UNNEST(m.request) as r
        CROSS JOIN UNNEST(m.response) as rs
        CROSS JOIN UNNEST(r.headers) as h
        ORDER BY timestamp DESC
        LIMIT 20
      `;
    } else if (logTable === LogTable.Function || logTable === LogTable.FunctionEdge) {
      sql = `
        SELECT 
          ${timestampSelect},
          id,
          event_message,
          m.function_id,
          m.execution_time_ms,
          m.deployment_id
        FROM ${logTable}
        CROSS JOIN UNNEST(metadata) as m
        ORDER BY timestamp DESC
        LIMIT 20
      `;
    } else {
      // 默认查询
      sql = `
        SELECT 
          ${timestampSelect},
          id,
          event_message
        FROM ${logTable}
        ORDER BY timestamp DESC
        LIMIT 20
      `;
    }
    
    // 构建API URL
    const queryParams = new URLSearchParams();
    queryParams.append('iso_timestamp_start', startTime);
    queryParams.append('iso_timestamp_end', endTime);
    queryParams.append('sql', sql);
    
    const apiUrl = `https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}/analytics/endpoints/logs.all?${queryParams.toString()}`;
    
    // 发送请求到Management API
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${SUPABASE_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    
    // 获取响应状态和内容
    const status = response.status;
    const apiData = await response.json();
    
    // 处理API响应数据
    let result = [];
    let errorMessage = '';
    let success = false;
    
    if (status === 200 && apiData && apiData.result) {
      result = apiData.result;
      success = true;
    } else {
      errorMessage = apiData?.message || '获取日志数据失败';
      success = false;
    }
    
    // 返回标准化的响应
    return new Response(JSON.stringify({
      success,
      status,
      data: result,
      error: errorMessage ? { message: errorMessage } : null,
      meta: {
        query: {
          type,
          table: logTable,
        timeRange: {
            start: startTime,
            end: endTime,
            startLocal: formatLocalTime(startTime), // 中国时区的时间
            endLocal: formatLocalTime(endTime),     // 中国时区的时间
            input: {
              start: iso_timestamp_start || null,   // 用户输入的原始时间
              end: iso_timestamp_end || null
            },
            duration: `${Math.round(diffHours)}小时`
          },
          sql
        },
        count: result.length,
        timestamp: new Date().toISOString()
      }
    }), {
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    });
  } catch (error) {
    // 错误处理
    console.error('Error:', error);
    return new Response(JSON.stringify({
      success: false,
      status: 500,
      data: [],
      error: {
        message: error.message
      },
      meta: {
        timestamp: new Date().toISOString()
      }
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    });
  }
});
```

### 3. 前端服务实现

在 `src/services/system/logs.ts` 中实现：

```typescript
import { supabase } from '../supabase/client';

// 定义日志类型枚举
export enum LogType {
  Auth = 'auth',
  Edge = 'edge',
  FunctionEdge = 'function_edge',
  Function = 'function',
  Postgres = 'postgres',
  Postgrest = 'postgrest',
  Realtime = 'realtime',
  Storage = 'storage'
}

// 日志查询参数接口
export interface LogQueryParams {
  type?: LogType | string;
  iso_timestamp_start?: string;
  iso_timestamp_end?: string;
}

/**
 * 获取系统日志
 * @param params 查询参数
 * @returns 日志数据
 * 
 * 注意：
 * 1. 默认查询最近24小时的日志
 * 2. 时间范围最大为24小时
 * 3. 可以直接使用北京时间，无需转换为UTC
 * 4. 使用ISO时间格式，如：2025-04-09T12:00:00（北京时间）
 */
export async function getSystemLogs(params: LogQueryParams = {}) {
  try {
    // 调用Edge Function
    const { data, error } = await supabase.functions.invoke('system-logs', {
      method: 'POST',
      body: params
    });
    
    if (error) throw error;
    return data;
  } catch (error) {
    console.error('获取系统日志失败:', error);
    throw error;
  }
}
```

## 日志类型和表名映射

Supabase提供以下日志表类型：

| 类型 | 表名 | 描述 |
|-----|------|------|
| auth | auth_logs | 认证日志，包含登录/注册等认证操作 |
| edge | edge_logs | 边缘/API日志，包含所有API请求 |
| function_edge | function_edge_logs | 函数调用日志，包含请求和响应 |
| function | function_logs | 函数执行日志，包含运行时输出 |
| pgbouncer | pgbouncer_logs | PostgreSQL连接池日志 |
| postgres | postgres_logs | 数据库日志 |
| postgrest | postgrest_logs | RESTful API服务器日志 |
| realtime | realtime_logs | 实时服务器日志 |
| storage | storage_logs | 存储服务日志 |
| supervisor | supervisor_logs | 监督服务日志 |

## 时区处理

Edge Function现在支持**直接输入北京时间**，无需手动转换：

1. **输入**：前端可以直接传入北京时间，如 `2025-04-09T12:00:00`
2. **转换**：Edge Function 自动将北京时间转换为UTC时间（减8小时）
3. **响应**：返回结果包含原始输入时间、UTC时间和格式化的北京时间

```json
"timeRange": {
  "start": "2025-04-09T04:00:00Z",       // UTC时间
  "end": "2025-04-09T05:00:00Z",         // UTC时间
  "startLocal": "2025-04-09 12:00:00",   // 北京时间
  "endLocal": "2025-04-09 13:00:00",     // 北京时间
  "input": {
    "start": "2025-04-09T12:00:00",      // 原始输入时间
    "end": "2025-04-09T13:00:00"
  },
  "duration": "1小时"
}
```

## SQL查询和嵌套数组

由于Supabase日志数据以嵌套数组结构存储，我们使用SQL `UNNEST()` 函数展开这些数组：

```sql
SELECT 
  datetime(timestamp, "Asia/Shanghai") as formatted_time,
  id,
  event_message,
  r.method as request_method,
  -- ... 其他字段
FROM edge_logs
CROSS JOIN UNNEST(metadata) as m
CROSS JOIN UNNEST(m.request) as r
CROSS JOIN UNNEST(m.response) as rs
CROSS JOIN UNNEST(r.headers) as h
ORDER BY timestamp DESC
LIMIT 20
```

这种方式允许我们:
1. 直接访问嵌套数据
2. 为复杂字段提供友好的别名
3. 在SQL层面直接转换时间戳为北京时间

## 响应格式

Edge Function返回的响应格式如下：

```json
{
  "success": true,              // 请求是否成功
  "status": 200,                // HTTP状态码
  "data": [                     // 日志数据数组
    {
      "formatted_time": "2025-04-09T12:50:42.746000",
      "id": "15f67bba-4ac7-4d2e-ab73-af2786f95127",
      "event_message": "POST | 200 | /functions/v1/system-logs",
      // ... 其他字段，根据日志类型不同而不同
    }
  ],
  "error": null,                // 错误信息（成功时为null）
  "meta": {                     // 元数据
    "query": {                  // 查询相关信息
      "type": "function_edge",
      "table": "function_edge_logs",
      "timeRange": {            // 时间范围信息
        "start": "2025-04-09T03:54:02Z",
        "end": "2025-04-09T04:54:02Z",
        "startLocal": "2025-04-09 11:54:02",
        "endLocal": "2025-04-09 12:54:02",
        "input": {
          "start": "2025-04-09T11:54:02",
          "end": "2025-04-09T12:54:02"
        },
        "duration": "1小时"
      },
      "sql": "SELECT ..."       // 实际执行的SQL查询
    },
    "count": 12,                // 返回的日志记录数量
    "timestamp": "2025-04-09T04:54:28.182Z"
  }
}
```

## 使用示例

### 1. 查询最近24小时的API日志

```typescript
import { getSystemLogs } from '@/services/system/logs';

// 不提供参数，默认查询最近24小时的API日志
const logs = await getSystemLogs();
```

### 2. 查询特定类型和时间范围的日志

```typescript
import { getSystemLogs, LogType } from '@/services/system/logs';

// 查询特定时间范围的函数日志（使用北京时间）
const logs = await getSystemLogs({
  type: LogType.Function,
  iso_timestamp_start: '2025-04-09T09:00:00', // 北京时间上午9点
  iso_timestamp_end: '2025-04-09T17:00:00'    // 北京时间下午5点
});
```

### 3. 查询认证日志

```typescript
import { getSystemLogs, LogType } from '@/services/system/logs';

// 查询最近24小时的认证日志
const logs = await getSystemLogs({
  type: LogType.Auth
});
```

## 安全考量

1. **不直接暴露Access Token**：使用Edge Function作为中间层，避免在前端暴露Supabase Management API令牌。

2. **时间范围限制**：自动将查询时间范围限制在24小时内，避免查询过大的数据量。

3. **参数验证**：对输入参数进行验证和处理，避免恶意输入。

4. **访问控制**：前端应实现访问控制，确保只有管理员用户可以访问日志页面。

## 前端实现建议

1. 创建日志管理页面，包含以下功能：
   - 日志类型选择器
   - 时间范围选择器
   - 日志列表显示（分页或虚拟滚动）
   - 日志详情查看

2. 为不同类型的日志设计不同的显示格式，例如：
   - API日志：显示请求方法、路径、状态码等
   - 函数日志：显示函数ID、执行时间等
   - 认证日志：突出显示用户ID和操作类型

3. 实现日志刷新和自动更新功能，方便实时监控。

## 部署步骤

1. 设置Supabase项目ID和访问令牌：
   - 在`system-logs/index.ts`中设置`SUPABASE_PROJECT_ID`和`SUPABASE_ACCESS_TOKEN`
   - 或使用环境变量（更安全）：`supabase secrets set SUPABASE_ACCESS_TOKEN=xxx`

2. 部署Edge Function：
   ```bash
   supabase functions deploy system-logs
   ```

3. 实现前端服务并集成到应用中。

