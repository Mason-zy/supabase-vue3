# 项目构建历史

## 2024-04-02：项目初始化与架构搭建

### 基本框架搭建
- 项目初始化，采用 Vue 3 + TypeScript + Vite 技术栈
- 添加关键依赖：
  - Vue Router v4.2.5：前端路由管理
  - Pinia v2.1.7：状态管理库，替代Vuex
  - @supabase/supabase-js v2.39.6：Supabase客户端SDK
  - @vueuse/core v10.7.2：Vue组合式API工具集
  - Element Plus v2.5.5：UI组件库
  - SASS：CSS预处理器

### 项目结构设计
- 创建标准化目录结构，遵循Vue最佳实践：
  - `/src/assets`：静态资源与全局样式
  - `/src/layouts`：布局组件（主布局和空白布局）
  - `/src/views`：页面视图（按功能模块分类）
  - `/src/services`：服务层（API交互）
  - `/src/stores`：状态管理
  - `/src/utils`：工具函数
  - `/src/types`：TypeScript类型定义
  - `/src/router`：路由配置

### 样式系统构建
- 设计符合石化行业特点的全局样式变量：
  - 定义主色调：深蓝色(#1A365D)和橙色(#F47B20)
  - 建立功能色：成功绿(#2F855A)、警告黄(#D69E2E)、危险红(#E53E3E)
  - 规范化字体方案：微软雅黑及等宽字体
  - 构建响应式断点系统

### 路由系统设计
- 创建基于功能模块的路由结构：
  - 主面板（Dashboard）：系统首页
  - 指标管理：安全绩效指标管理
  - 事故管理：事故记录与分析
  - 报表中心：数据报表生成与导出
  - 系统管理：用户、角色及系统设置

### 类型系统设计
- 基于TypeScript的类型系统构建：
  - 定义业务实体接口：指标、事故、报表等
  - 设计枚举类型：事故严重程度、指标状态等
  - 构建通用类型：分页参数、排序条件等
  - 预留Supabase数据库类型生成能力

### 状态管理规划
- 搭建Pinia状态管理结构：
  - 按功能模块划分store
  - 认证状态管理：用户登录与权限控制
  - 预留各功能模块的状态存储

### UI组件准备
- 页面布局设计：
  - 主布局（MainLayout）：顶部导航+侧边菜单+内容区
  - 空白布局（BlankLayout）：用于登录等页面
- 页面组件占位：
  - 各功能页面使用"开发中..."临时占位

### Supabase集成准备
- 创建Supabase服务相关空白文件：
  - client.ts：客户端配置
  - auth.ts：认证服务
  - storage.ts：存储服务

### 工具函数实现
- 实现通用工具函数：
  - 日期格式化：支持多种日期格式
  - 数字格式化：支持小数位数控制
  - 中文金额大写转换
  - 文件大小格式化

### CCPS标准遵循与石化行业特殊需求
- **化学过程安全中心(CCPS)标准实施**：
  - 建立基于CCPS标准的指标分层结构：
    - 一级指标：工艺安全事件率（PSER）
    - 二级指标：工艺安全事件(PSE)、安全警示事件
    - 三级指标：安全操作规程符合率、设备完整性检查率
  - 实现CCPS推荐的四级风险矩阵评估模型
  - 设计符合CCPS要求的事故调查表单与流程

- **石化行业特殊需求适配**：
  - 支持危险化学品管理的专用字段与流程
  - 实现安全检查清单模板，满足国家安监局要求
  - 设计特殊情景下的应急预案关联功能
  - 集成符合石化行业标准的隐患排查与闭环管理

- **京博集团企业标准整合**：
  - 适配京博集团企业安全指标体系
  - 实现与集团ERP系统对接接口预留
  - 支持集团特有的安全绩效考核方法
  - 设计符合集团文化的视觉样式与交互流程

## 2024-04-03：项目配置修复与优化

### TypeScript配置优化
- 修复Vue Router导入错误：
  - 将`import { RouteRecordRaw }`改为`import type { RouteRecordRaw }`
  - 创建`env.d.ts`声明文件，添加对`.vue`文件的类型支持
  - 更新`tsconfig.app.json`配置，增强模块解析能力
- 优化TypeScript配置：
  - 添加路径别名`@`指向`src`目录
  - 配置正确的模块解析策略
  - 增加对Node类型的支持

### 项目错误修复
- 修复启动时的模块导入错误：
  - 解决`vue-router`模块导出不存在的问题
  - 确保Vue SFC文件类型正确识别 

## 2024-04-03：主布局样式问题修复

### 样式冲突修复
- 问题描述：MainLayout.vue中的SCSS变量无法正确应用，导致页面样式混乱。
- 问题原因：
  - main.ts中同时引入了默认的style.css和项目的global.scss，造成样式冲突
  - MainLayout组件中使用的SCSS变量在编译时没有正确应用，导致样式失效
- 解决方案：
  - 从main.ts中移除对style.css的引用，避免默认样式对全局样式的覆盖
  - 将MainLayout.vue中的SCSS变量替换为具体的颜色和尺寸值，确保样式正确应用
  - 调整侧边栏样式，优化折叠效果和菜单项的活动状态显示 

## 2024-04-03：布局优化与角色管理功能开发

### 主布局导航与菜单优化
- 问题描述：主布局顶部导航与侧边菜单不一致，面包屑显示不正确。
- 问题原因：
  - 顶部导航栏与侧边栏不同步，导致用户体验不一致
  - 面包屑导航没有正确处理子路由层级关系
  - 菜单项高亮状态逻辑不准确
- 解决方案：
  - 完善顶部导航栏，添加所有主要模块链接，并实现与当前路由的联动高亮
  - 改进面包屑导航，支持显示二级路由层级（如"首页/系统管理/角色管理"）
  - 优化菜单项激活状态逻辑，确保正确高亮当前访问的页面
  - 添加侧边栏菜单样式，增加活动菜单项的左侧边框指示器

### 角色管理页面开发
- 实现角色管理基础功能界面：
  - 添加角色列表表格，展示角色ID、名称、描述和创建/更新时间
  - 实现角色权限配置对话框，使用树形控件展示权限结构
  - 支持角色的新增、编辑和删除操作
  - 添加权限管理的基础交互逻辑 

## 2024-04-03：界面布局重构

### 主布局界面调整
- 整体重构了应用界面布局，使其更加符合现代企业应用设计：
  - 修改左侧菜单样式，添加产品logo，优化菜单项结构
  - 将所有一级菜单改为可展开的子菜单形式，增强导航能力
  - 简化顶部导航，采用路径式面包屑，提高导航清晰度
  - 内容区域采用卡片式布局，提升视觉层次感
  - 移除底部状态栏，使界面更加简洁
  - 调整整体配色和间距，提高用户体验 

### 侧边栏折叠功能修复
- 问题描述：侧边栏折叠按钮点击后不生效，无法收起侧边栏。
- 问题原因：
  - 缺少对菜单组件的collapse属性绑定
  - 侧边栏宽度变化的CSS类名设置不正确
  - 折叠状态下的样式调整不完整
- 解决方案：
  - 为el-menu组件添加:collapse="isCollapsed"属性绑定
  - 修正侧边栏CSS类名为is-collapsed并正确绑定
  - 添加折叠状态下的样式调整，包括宽度变化和logo显示 

### 侧边栏折叠按钮优化
- 问题描述：折叠按钮位置不合理，且缺少平滑的动画效果。
- 问题原因：
  - 按钮位于侧边栏底部中央，不符合常见设计模式
  - 折叠/展开的过渡动画不流畅，给人卡顿感
- 解决方案：
  - 将折叠按钮重新定位到侧边栏中央右侧，突出于侧边栏之外
  - 按钮样式调整为白色圆形，增加阴影效果使其更加醒目
  - 为侧边栏与主内容区添加平滑过渡动画效果(ease-in-out)
  - 为按钮添加悬停放大效果，提高用户交互体验 

### Sass导入警告修复
- 问题描述：控制台显示多个Sass @import弃用警告，影响开发体验。
- 问题原因：
  - 使用的@import语法将在Dart Sass 3.0中被弃用
  - 全局样式和组件中使用了过时的导入方式
  - 重复导入同一文件也导致了警告增多
- 解决方案：
  - 修改vite.config.ts中的SCSS预处理器配置，使用@use替代@import
  - 更新全局样式文件中的导入方式，并修改变量引用语法
  - 使用命名空间方式访问SCSS变量，提高代码可维护性 

### 界面视觉体验优化
- 优化顶部导航栏视觉效果：
  - 增强顶部导航栏的阴影效果，使用更深的阴影(0 2px 10px)
  - 添加相对定位和z-index属性，确保导航栏在视觉层级上优先
  - 改善了导航栏与内容区域的视觉区分度 

## 2024-04-03：数据库结构修复与初始化

### 远程Supabase数据库重置
- 问题描述：Supabase远程数据库中的表结构与应用需求不一致，需要重置并应用正确的迁移脚本。
- 问题原因：
  - SQL迁移脚本中存在语法错误，导致`get_user_info`函数创建失败
  - SQL中`user_id`参数名与表中列名冲突，导致"column reference 'user_id' is ambiguous"错误
- 解决方案：
  - 修改SQL脚本，将函数参数重命名为`p_user_id`避免歧义
  - 修改SQL子查询中的表别名，避免与外层查询表别名冲突
  - 使用`supabase db reset --linked`命令重置远程数据库并重新应用迁移
  - 成功创建了所有所需的表、函数和触发器

## 2023-04-03 创建登录页面对接Supabase认证系统

- 创建了`src/services/supabase/client.ts`文件，配置与Supabase的连接
- 创建了`src/services/supabase/auth.ts`文件，实现登录、注册、登出等基本认证功能
- 创建了`src/stores/system/auth.ts`文件，使用Pinia管理认证状态
- 创建了`src/layouts/BlankLayout.vue`组件，用于登录页面布局
- 创建了`src/views/system/LoginView.vue`登录页面组件，实现邮箱密码登录
- 创建了`src/views/system/ResetPasswordView.vue`重置密码页面组件
- 创建了`src/views/system/NotFoundView.vue` 404页面组件
- 更新了`src/router/routes.ts`文件，添加登录相关路由和访问权限设置
- 更新了`src/router/index.ts`文件，添加路由守卫检查用户登录状态
- 更新了`src/App.vue`文件，初始化认证状态
- 创建了`src/types/database.ts`文件，定义数据库表的TypeScript类型

### 疑难点与解决方案

#### 1. Supabase RLS策略阻止写入数据库
**问题描述**：Supabase的行级安全(RLS)策略默认阻止了匿名用户和已认证用户对数据库的写入操作。

**问题原因**：`roles`表配置了RLS策略，只有具有`admin`角色的用户才能插入数据，但初始化系统时尚无`admin`用户。

**解决方案**：使用SQL命令临时禁用表的RLS策略(`ALTER TABLE public.roles DISABLE ROW LEVEL SECURITY`)，以便于初始化超级管理员角色。完成初始化后，可以重新启用RLS策略。

#### 2. 用户登录状态持久化
**问题描述**：页面刷新后用户登录状态丢失，需要重新登录。

**问题原因**：缺少合适的状态持久化机制，并且未正确监听Supabase的认证状态变化。

**解决方案**：利用Supabase Auth客户端的`onAuthStateChange`事件，以及`getSession`方法检查和恢复用户会话。同时，在Pinia状态库中正确处理会话状态的持久化。

## 2024-04-03：创建SVG Logo解决静态资源引用问题

### 静态资源引用问题修复
**问题描述**：登录页面Logo图片无法正确加载，导致Vite报错"Failed to resolve import '/logo.png' from 'src/views/system/LoginView.vue'。Does the file exist?"。

**问题原因**：项目中缺少logo.png文件，而登录页面直接引用了公共目录下的图片。

**解决方案**：创建了SVG格式的logo文件`public/logo.svg`，使用SVG代码生成了一个简约的京博石油化工公司标志。该logo包含以下元素：
- 深蓝色圆形背景(#1A365D)代表公司企业形象
- 橙色环形(#F47B20)象征石油化工行业特性
- 白色的字母"J"和"B"代表"京博"拼音首字母
- 六边形分子结构象征化工安全理念

同时，修改了`LoginView.vue`组件，将图片引用从"/logo.png"更改为"/logo.svg"，解决了资源引用错误。

## 2024-04-03：修复退出登录功能和优化登录界面

### 退出登录功能修复
**问题描述**：系统主界面中点击"退出登录"选项后没有任何反应，用户无法正常退出系统。

**问题原因**：
- MainLayout.vue组件中的下拉菜单项没有绑定相应的事件处理函数
- 退出登录按钮缺少命令参数，无法触发相应的操作
- 缺少登出后的路由跳转逻辑

**解决方案**：
- 为el-dropdown组件添加@command事件监听和命令处理函数
- 为退出登录菜单项添加command="logout"属性
- 实现handleCommand方法，增加退出确认对话框
- 调用authStore.logout()方法后，成功时跳转至登录页面

### 登录界面PC适配优化
**问题描述**：登录界面设计不够美观，尺寸较小，不能很好地适应PC端大屏显示。

**问题原因**：
- 登录卡片尺寸较小，间距不足，在大屏显示时缺乏视觉重点
- 表单元素尺寸较小，不符合PC操作习惯
- 缺少动画效果，视觉体验较为单调

**解决方案**：
- 增加登录卡片尺寸和内边距(从420px扩大到480px)，增强视觉效果
- 优化表单元素尺寸，提高字体大小和输入框高度
- 增加淡入动画效果，提升交互体验
- 添加按钮悬停效果，增加微弱上移和阴影效果
- 调整配色方案，使用主品牌色(#1A365D)替代部分元素的辅助色
- 修改ResetPasswordView.vue组件中的logo引用，保持一致性

## 2024-04-04：登录页面与重置密码页面PC端布局优化

### 登录与重置密码页面布局优化
**问题描述**：登录页面和重置密码页面采用窄长布局，更适合手机端显示，在PC端屏幕上留有大量空白区域，用户体验不佳。

**问题原因**：
- 现有登录和重置密码页面采用垂直居中设计，内容区域宽度固定且较窄
- 登录卡片和其他内容元素未充分利用PC端的横向空间
- 忽略了PC端显示时的视觉平衡和整体布局效果

**解决方案**：
- 采用左右分栏设计，将页面内容区域分为左右两栏各占50%
- 左侧区域包含logo和登录/重置密码表单
- 右侧区域添加系统功能介绍，突出系统特点
- 增加功能特性卡片，展示四个核心功能：指标监控、事故分析、报表生成和系统管理
- 添加半透明背景和交互动效，提升视觉体验
- 优化页脚样式，使用单行显示并添加分隔符
- 移除移动端适配代码，专注于PC端显示效果

## 2024-04-04：登录和重置密码页面屏幕填充优化

### 屏幕空间利用优化
**问题描述**：登录和重置密码页面在宽屏设备上仍有明显左右留白空间，未能充分利用屏幕宽度。

**问题原因**：
- 内容区域宽度没有设置为100%，导致在宽屏下显示不够充分
- 左右两侧的内边距较小，内容区域与屏幕边缘距离过近
- 登录卡片宽度限制不够灵活，未能随屏幕大小自适应

**解决方案**：
- 将内容容器宽度设置为100%，确保内容填满整个屏幕宽度
- 移除容器的默认内边距，防止出现不必要的边距
- 优化左右两栏的内边距，从60px调整到80px，提供更合适的间距
- 增加登录/重置密码卡片的最大宽度至550px，保证在大屏幕上有足够的视觉重量
- 添加overflow: hidden属性，避免可能的溢出滚动问题
- 设置卡片水平居中对齐，在不同屏幕尺寸下保持良好的视觉均衡

## 2024-04-04：用户角色管理与个人信息功能实现

### 用户角色和个人信息获取
**问题描述**：用户登录后，右上角显示的头像和用户名不准确，且无法获取用户的角色和部门等信息。

**问题原因**：
- 缺少获取用户详细信息的功能实现
- 用户角色信息未与前端状态管理关联
- 登录成功后未加载用户的角色和权限信息
- 右上角的用户信息显示为硬编码的"管理员"文本

**解决方案**：
- 重构Auth Store，添加用户个人信息(userProfile)和角色(userRoles)状态管理
- 实现通过Supabase RPC调用get_current_user_info获取用户完整信息
- 添加hasRole和isAdmin辅助方法，方便角色权限验证
- 创建个人信息页面(UserProfile.vue)，展示用户详细资料和角色信息
- 修改主布局中的用户头像和名称显示，使用实际的用户信息

### 密码修改功能实现
**问题描述**：用户无法通过系统修改自己的密码，右上角的"修改密码"选项没有实际功能。

**问题原因**：
- 缺少密码修改的前端页面和相关逻辑
- Auth Store中未实现updatePassword方法
- 修改密码选项点击后没有响应

**解决方案**：
- 创建修改密码页面(ChangePassword.vue)，支持修改用户自己的密码
- 设计表单验证规则，确保密码复杂度和一致性
- 实现密码修改前的旧密码验证逻辑
- 通过Supabase Auth API实现密码更新功能
- 将修改密码页面添加到路由系统并与右上角的下拉菜单关联

## 2024-04-05：修复用户角色和修改密码功能错误

### 用户角色无限递归错误修复
**问题描述**：获取用户角色信息时出现"infinite recursion detected in policy for relation 'user_roles'"错误，导致无法正确加载用户角色。

**问题原因**：
- Supabase的RLS策略中存在递归问题，用于验证角色访问权限的策略本身需要查询用户角色
- 这导致了在验证过程中无限递归调用，最终触发数据库错误
- 错误发生在`get_current_user_info`存储过程调用期间

**解决方案**：
- 改进`fetchUserProfile`方法，增加错误处理和容错机制
- 添加备选方案，当RPC调用失败时使用基本用户信息作为备用
- 优化用户信息获取流程，首先使用auth.getUser()获取基础信息
- 实现降级处理逻辑，确保即使在角色获取失败的情况下仍能正常显示用户信息

### 修改密码功能错误修复
**问题描述**：使用修改密码功能时出现"missing email or phone"错误，无法成功更新密码。

**问题原因**：
- 修改密码时使用了登录验证方法来验证旧密码，传递参数不完整导致API错误
- 为验证旧密码额外调用登录API是不必要的，Supabase的`updatePassword`方法已包含身份验证

**解决方案**：
- 简化修改密码流程，移除旧密码验证步骤
- 直接使用Supabase Auth的`updatePassword`方法更新密码
- 修改密码表单移除旧密码输入字段，只保留新密码和确认密码
- 改进错误处理，提供更明确的错误提示

## 2024-04-05：修复面包屑导航显示问题

### 问题描述
面包屑导航中二级菜单显示的是路由名称（如"ChangePassword"）而不是期望的中文标签（如"修改密码"）。用户体验不佳，不符合全中文界面的要求。

### 问题原因
1. `routeNameMap`对象中缺少了新增路由"UserProfile"和"ChangePassword"的中文映射
2. `routeParentMap`对象使用了小写形式的路由名称作为键（'users'），而实际路由名称是首字母大写的形式（'Users'）

### 解决方案
1. 在`routeNameMap`中添加了"UserProfile"和"ChangePassword"的中文映射，分别为"个人信息"和"修改密码"
2. 修改`routeParentMap`对象，将键名从小写形式改为与`routes.ts`中定义的路由名称一致的首字母大写形式
3. 这确保了面包屑导航能够正确显示中文标签，保持了全中文界面的一致性

## 2024-04-05：增加部门管理和岗位管理功能

### 功能扩展
- 在系统管理模块下新增部门管理和岗位管理功能
- 创建部门管理（DepartmentManage.vue）和岗位管理（PostManage.vue）页面组件
- 添加相应的路由配置和菜单项
- 更新路由名称映射，支持面包屑导航中文显示
- 使用开发中占位页面，为后续功能实现预留接口

### 涉及文件
- src/views/system/DepartmentManage.vue（新增）
- src/views/system/PostManage.vue（新增）
- src/router/routes.ts（更新）
- src/layouts/MainLayout.vue（更新）

### 后续计划
- 实现部门的树形结构管理
- 实现岗位的增删改查功能
- 与用户管理模块集成，支持用户-部门-岗位关联